define( [
    'tests/osgWrappers/osgAnimation',
    'osgWrappers/serializers/osgAnimation',
    'osgDB/Input',
    'qunit',
    'tests/mockup/mockup'
], function ( osgAnimation, osgAnimationWrapper, Input, QUnit, mockup ) {

    'use strict';

    return function () {

        QUnit.module( 'osgWrapper' );

        QUnit.asyncTest( 'osgWrapperTest', function () {

            var vec3LerpChannel = {
                "osgAnimation.Vec3LerpChannel": {
                    "Name": "scale",
                    "TargetName": "Cylindre_8_2",
                    "KeyFrames": [
                        [ 0, 1, 1, 1 ],
                        [ 0.1, 1, 1, 1 ],
                        [ 0.133333, 1, 1, 1 ],
                        [ 0.166667, 1, 1, 1 ],
                        [ 0.2, 1, 1, 1 ],
                        [ 0.233333, 1, 1, 1 ],
                        [ 0.266667, 1, 1, 1 ],
                        [ 0.3, 1, 1, 1 ],
                        [ 0.833333, 1, 1, 1 ],
                        [ 0.866667, 1, 1, 1 ],
                        [ 0.9, 1, 1, 1 ],
                        [ 0.933333, 1, 1, 1 ],
                        [ 0.966667, 1, 1, 1 ],
                        [ 1, 1, 1, 1 ],
                        [ 1.03333, 1, 1, 1 ],
                        [ 1.76667, 1, 1, 1 ],
                        [ 1.8, 1, 1, 1 ],
                        [ 1.83333, 1, 1, 1 ],
                        [ 1.86667, 1, 1, 1 ],
                        [ 1.9, 1, 1, 1 ],
                        [ 1.93333, 1, 1, 1 ],
                        [ 1.96667, 1, 1, 1 ],
                        [ 2.06667, 1, 1, 1 ],
                        [ 2.1, 1, 1, 1 ],
                        [ 2.13333, 1, 1, 1 ],
                        [ 2.3, 1, 1, 1 ],
                        [ 2.33333, 1, 1, 1 ],
                        [ 2.36667, 1, 1, 1 ],
                        [ 2.4, 1, 1, 1 ],
                        [ 2.43333, 1, 1, 1 ],
                        [ 2.46667, 1, 1, 1 ],
                        [ 2.5, 1, 1, 1 ]
                    ]
                }
            };

            ( new Input ).setJSON( vec3LerpChannel ).readObject().then( function ( channel ) {
                ok( channel.keys.length === 96, 'Check keys length' );
                ok( channel.times.length === 32, 'Check times length' );

                var valid = true;
                var size = channel.times.length;
                var keys = channel.keys;
                for ( var i = 0; i < size; i++ ) {
                    var id = i * 3;

                    if ( keys[ id ] !== 1 || keys[ id + 1 ] !== 1 || keys[ id + 2 ] !== 1 ) {
                        valid = false;
                        break;
                    }
                }
                ok( valid, 'Check channel keys values' );

                ok( channel.times[ 0 ] === 0, 'Check first key frame time' );
                ok( channel.times[ channel.times.length - 1 ] === 2.5, 'Check last key frame time' );


            } );

            var FloatLerpChannel = {
                "osgAnimation.FloatLerpChannel": {
                    "Name": "rotateX",
                    "TargetName": "Cylindre_8_2",
                    "KeyFrames": [
                        [ 0, -3.14159 ],
                        [ 0.133333, -3.14159 ],
                        [ 0.166667, -3.14159 ],
                        [ 0.2, -3.14159 ],
                        [ 0.233333, -3.14159 ],
                        [ 0.266667, -3.14159 ],
                        [ 0.3, -3.14159 ],
                        [ 0.333333, -3.14159 ],
                        [ 0.866667, -3.14159 ],
                        [ 0.9, -3.14159 ],
                        [ 0.933333, -3.14159 ],
                        [ 0.966667, -3.14159 ],
                        [ 1, -3.14159 ],
                        [ 1.76667, -3.14159 ],
                        [ 1.8, -3.14159 ],
                        [ 1.83333, -3.14159 ],
                        [ 1.86667, -3.14159 ],
                        [ 1.9, -3.14159 ],
                        [ 1.93333, -3.14159 ],
                        [ 1.96667, -3.14159 ],
                        [ 2, -3.14159 ],
                        [ 2.3, -3.14159 ],
                        [ 2.33333, -3.14159 ],
                        [ 2.36667, -3.14159 ],
                        [ 2.4, -3.14159 ],
                        [ 2.43333, -3.14159 ],
                        [ 2.46667, -3.14159 ],
                        [ 2.5, -3.14159 ]
                    ]
                }
            };

            ( new Input ).setJSON( FloatLerpChannel ).readObject().then( function ( channel ) {

                var times = [ 0, 0.133333, 0.166667, 0.2, 0.233333, 0.266667, 0.3, 0.333333, 0.866667, 0.9, 0.933333, 0.966667, 1, 1.76667, 1.8, 1.83333, 1.86667, 1.9, 1.93333, 1.96667, 2, 2.3, 2.33333, 2.36667, 2.4, 2.43333, 2.46667, 2.5 ];
                var keys = [ -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159, -3.14159 ];


                ok( channel.keys.length === 28, 'Check keys length' );
                ok( channel.times.length === 28, 'Check times length' );

                var validTimes = true;
                var validKeys = true;

                var size = channel.times.length;

                for ( var i = 0; i < size; i++ ) {
                    var key = channel.keys[ i ];
                    var time = channel.times[ i ];

                    if ( !mockup.checkNear( key, keys[ i ] ) ) {
                        validKeys = false;
                        break;
                    }
                    if ( !mockup.checkNear( time, times[ i ] ) ) {
                        validTimes = false;
                        break;
                    }
                }
                ok( validTimes, 'Check channel times values' );
                ok( validKeys, 'Check channel keys values' );

            } );

            var basicAnimationManager = {
                "osgAnimation.BasicAnimationManager": {
                    "Animations": [ {
                        "osgAnimation.Animation": {
                            "Name": "C4D Animation Take",
                            "Channels": [ {
                                "osgAnimation.Vec3LerpChannel": {
                                    "Name": "translate",
                                    "TargetName": "Cylindre_8_2",
                                    "KeyFrames": [
                                        [ 0, 0, 24.2494, 0 ],
                                        [ 0.1, 0, 24.2494, 0 ],
                                        [ 0.133333, -1.42109e-14, 24.2494, 0 ],
                                        [ 0.166667, -1.42109e-14, 24.2494, 7.10543e-15 ],
                                        [ 0.2, -1.42109e-14, 24.2494, -7.10543e-15 ],
                                        [ 0.233333, 0, 24.2494, 0 ],
                                        [ 0.266667, 1.42109e-14, 24.2494, 0 ],
                                        [ 0.3, 0, 24.2494, 0 ],
                                        [ 0.833333, 0, 24.2494, 0 ],
                                        [ 0.866667, -1.42109e-14, 24.2494, -7.10543e-15 ],
                                        [ 0.9, 0, 24.2494, -1.42109e-14 ],
                                        [ 0.933333, 0, 24.2494, 0 ],
                                        [ 0.966667, -1.42109e-14, 24.2494, 0 ],
                                        [ 1, 0, 24.2494, -1.42109e-14 ],
                                        [ 1.03333, 0, 24.2494, 0 ],
                                        [ 1.06667, 0, 24.2494, 0 ],
                                        [ 1.1, 0, 24.2494, 0 ],
                                        [ 1.13333, 0, 24.2494, 0 ],
                                        [ 1.76667, 0, 24.2494, 0 ],
                                        [ 1.8, 0, 24.2494, 0 ],
                                        [ 1.83333, 0, 24.2494, 0 ],
                                        [ 1.86667, -1.42109e-14, 24.2494, 0 ],
                                        [ 1.9, 0, 24.2494, 7.10543e-15 ],
                                        [ 1.93333, 0, 24.2494, 7.10543e-15 ],
                                        [ 1.96667, 0, 24.2494, 1.42109e-14 ],
                                        [ 2.06667, 0, 24.2494, 1.42109e-14 ],
                                        [ 2.1, -1.42109e-14, 24.2494, 0 ],
                                        [ 2.13333, 0, 24.2494, 1.42109e-14 ],
                                        [ 2.3, 0, 24.2494, 1.42109e-14 ],
                                        [ 2.33333, -1.42109e-14, 24.2494, 0 ],
                                        [ 2.36667, 0, 24.2494, 0 ],
                                        [ 2.4, -1.42109e-14, 24.2494, 0 ],
                                        [ 2.43333, 0, 24.2494, -7.10543e-15 ],
                                        [ 2.46667, 0, 24.2494, -7.10543e-15 ],
                                        [ 2.5, 0, 24.2494, 0 ]
                                    ]
                                }
                            }, {
                                "osgAnimation.FloatLerpChannel": {
                                    "Name": "rotateX",
                                    "TargetName": "base_1_2",
                                    "KeyFrames": [
                                        [ 0, 0 ],
                                        [ 0.566667, 0 ],
                                        [ 0.6, 8.67362e-19 ],
                                        [ 0.633333, 0 ],
                                        [ 0.666667, 0 ],
                                        [ 0.7, 3.46945e-18 ],
                                        [ 0.733333, 0 ],
                                        [ 0.766667, 0 ],
                                        [ 0.8, 6.93889e-18 ],
                                        [ 0.833333, 6.93889e-18 ],
                                        [ 0.866667, 0 ],
                                        [ 0.9, 6.93889e-18 ],
                                        [ 0.933333, 0 ],
                                        [ 0.966667, 0 ],
                                        [ 1, 1.38778e-17 ],
                                        [ 1.03333, 0 ],
                                        [ 1.06667, 0 ],
                                        [ 1.1, 6.93889e-18 ],
                                        [ 1.13333, 0 ],
                                        [ 1.16667, 3.46945e-18 ],
                                        [ 1.2, 0 ],
                                        [ 1.4, 0 ],
                                        [ 1.43333, 1.0842e-19 ],
                                        [ 1.46667, 0 ],
                                        [ 2.2, 0 ],
                                        [ 2.23333, 1.73472e-18 ],
                                        [ 2.26667, 0 ],
                                        [ 2.3, 0 ],
                                        [ 2.33333, 6.93889e-18 ],
                                        [ 2.36667, 0 ],
                                        [ 2.4, 6.93889e-18 ],
                                        [ 2.43333, 0 ],
                                        [ 2.46667, 6.93889e-18 ],
                                        [ 2.5, 0 ],
                                        [ 2.6, 0 ],
                                        [ 2.63333, 3.46945e-18 ],
                                        [ 2.66667, 3.46945e-18 ],
                                        [ 2.7, 0 ]
                                    ]
                                }
                            }, {
                                "osgAnimation.FloatLerpChannel": {
                                    "Name": "rotateY",
                                    "TargetName": "base_1_2",
                                    "KeyFrames": [
                                        [ 0, -0 ],
                                        [ 0.766667, 0 ],
                                        [ 0.8, 2.77556e-17 ],
                                        [ 0.833333, 0 ],
                                        [ 1.03333, 0 ],
                                        [ 1.06667, 2.77556e-17 ],
                                        [ 1.1, 2.77556e-17 ],
                                        [ 1.13333, 0 ],
                                        [ 1.2, 0 ],
                                        [ 1.23333, 2.77556e-17 ],
                                        [ 1.26667, 2.77556e-17 ],
                                        [ 1.3, 0 ],
                                        [ 2.16667, 0 ],
                                        [ 2.2, 2.77556e-17 ],
                                        [ 2.23333, 0 ],
                                        [ 2.33333, 0 ],
                                        [ 2.36667, 2.77556e-17 ],
                                        [ 2.4, 5.55112e-17 ],
                                        [ 2.43333, 0 ],
                                        [ 2.46667, 2.77556e-17 ],
                                        [ 2.5, 0 ],
                                        [ 2.66667, 0 ],
                                        [ 2.7, 2.77556e-17 ],
                                        [ 2.73333, 0 ],
                                        [ 2.76667, 2.77556e-17 ],
                                        [ 2.8, 2.77556e-17 ],
                                        [ 2.83333, 0 ]
                                    ]
                                }
                            }, {
                                "osgAnimation.FloatLerpChannel": {
                                    "Name": "rotateY",
                                    "TargetName": "4x4",
                                    "KeyFrames": [
                                        [ 0, 0.174533 ],
                                        [ 0.166667, 0.174533 ],
                                        [ 0.2, 0.174533 ],
                                        [ 0.233333, 0.174533 ],
                                        [ 0.266667, 0.174533 ],
                                        [ 0.433333, 0.174533 ],
                                        [ 0.466667, 0.174533 ],
                                        [ 0.5, 0.174533 ],
                                        [ 0.533333, 0.174533 ],
                                        [ 0.7, 0.174533 ],
                                        [ 0.733333, 0.174533 ],
                                        [ 0.766667, 0.174533 ],
                                        [ 0.9, 0.174533 ],
                                        [ 0.933333, 0.174533 ],
                                        [ 0.966667, 0.174533 ],
                                        [ 1, 0.174533 ],
                                        [ 1.23333, 0.174533 ],
                                        [ 1.26667, 0.174533 ],
                                        [ 1.3, 0.174533 ],
                                        [ 1.33333, 0.174533 ],
                                        [ 1.5, 0.174533 ],
                                        [ 1.53333, 0.174533 ],
                                        [ 1.56667, 0.174533 ],
                                        [ 1.9, 0.174533 ],
                                        [ 1.93333, 0.174533 ],
                                        [ 1.96667, 0.174533 ],
                                        [ 2, 0.174533 ],
                                        [ 2.03333, 0.174533 ],
                                        [ 2.16667, 0.174533 ],
                                        [ 2.2, 0.174533 ],
                                        [ 2.23333, 0.174533 ],
                                        [ 2.26667, 0.174533 ],
                                        [ 2.3, 0.174533 ],
                                        [ 2.43333, 0.174533 ],
                                        [ 2.46667, 0.174533 ],
                                        [ 2.5, 0.174533 ],
                                        [ 2.53333, 0.174533 ]
                                    ]
                                }
                            } ]
                        }
                    } ]
                }
            };

            ( new Input ).setJSON( basicAnimationManager ).readObject().then( function ( bam ) {

                var bim = bam;

                ok( Object.keys( bam.getAnimations() ).length === 1, 'Check Animation count' );
                ok( bam.getAnimations()[ Object.keys( bam.getAnimations() )[ 0 ] ].channels.length === 4, 'Check channel count' );




            } );


            start();
        } );

    };

} );
